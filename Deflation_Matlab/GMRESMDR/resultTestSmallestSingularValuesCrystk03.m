% %svd of subdomain1
% ssubdomain_i_k=svds(subdomain_i,k,'smallest');
% 
% %svd of R22_subdomain1
% sR22_subdomain_i_k=svds(R22_subdomain_i,k,'smallest');
% 
% %compare
% compare_mat = [ssubdomain_i_k sR22_subdomain_i_k]


i =
     1
last_k_columns_matrix_i =
  Columns 1 through 8
         636        1975       12053        1454        2126         918        1167        1528
  Columns 9 through 16
        1610        1604        2425        1638        2332         965         886        2617
  Columns 17 through 20
        1392        1620         928        1403
compare_mat =
   3.7672e-02   1.7703e-01
   3.6423e-02   1.6607e-01
   3.2946e-02   1.5961e-01
   2.9165e-02   1.5638e-01
   2.8752e-02   1.4823e-01
   2.7685e-02   1.4571e-01
   2.6889e-02   1.4364e-01
   2.4596e-02   1.3518e-01
   2.2352e-02   1.3068e-01
   2.1692e-02   1.1549e-01
   2.1161e-02   1.1274e-01
   2.1031e-02   1.0020e-01
   1.7807e-02   9.2240e-02
   1.5621e-02   8.7707e-02
   1.4552e-02   6.8218e-02
   1.1175e-02   6.3183e-02
   9.1143e-03   5.0541e-02
   8.2406e-03   4.0884e-02
   4.9307e-03   2.2657e-02
   2.2715e-03   1.0671e-02
   
   i =
     2
last_k_columns_matrix_i =
  Columns 1 through 8
        4096        2736       11969        3569        2903        3940        4517        3560
  Columns 9 through 16
        3477        3467        5167        3458        3746        5033        4117        5160
  Columns 17 through 20
        3316        3277        4060        3311
compare_mat =
   6.5047e-03   3.6753e-02
   6.4507e-03   3.5212e-02
   6.0728e-03   3.0064e-02
   6.0264e-03   2.6681e-02
   5.8376e-03   2.6382e-02
   5.5511e-03   2.4076e-02
   5.2476e-03   2.2337e-02
   4.2541e-03   2.0476e-02
   3.5590e-03   1.8890e-02
   3.4373e-03   1.8215e-02
   3.3853e-03   1.4520e-02
   2.6696e-03   1.2776e-02
   2.5762e-03   1.0885e-02
   1.9002e-03   9.1823e-03
   1.6357e-03   6.9660e-03
   1.4228e-03   5.4176e-03
   8.5604e-04   4.1551e-03
   5.2735e-04   1.9090e-03
   3.1315e-04   1.2825e-03
   8.6000e-05   2.5681e-04

   i =
     3
last_k_columns_matrix_i =
  Columns 1 through 8
        6783        5753        6544        5923        5801        6439        6474        8372
  Columns 9 through 16
        5684        5963        6032        5890        5583        7063        5988        6186
  Columns 17 through 20
        5826        5812        5746        5625
compare_mat =
   7.0152e-03   3.7038e-02
   6.5223e-03   3.5251e-02
   6.3323e-03   3.0442e-02
   6.0781e-03   2.9830e-02
   6.0258e-03   2.9603e-02
   5.6547e-03   2.4364e-02
   5.2949e-03   2.1981e-02
   4.4684e-03   2.0430e-02
   3.9522e-03   1.8566e-02
   3.4402e-03   1.7679e-02
   3.4070e-03   1.5167e-02
   2.7077e-03   1.3094e-02
   2.5970e-03   1.0890e-02
   2.1579e-03   9.8784e-03
   1.6361e-03   6.8932e-03
   1.4254e-03   5.4171e-03
   9.5645e-04   4.5136e-03
   5.2851e-04   1.8697e-03
   3.3008e-04   1.2432e-03
   8.6897e-05   2.5659e-04

   i =
     4
last_k_columns_matrix_i =
  Columns 1 through 8
       11132        9693        8872        9214        9678        8711        8801        9096
  Columns 9 through 16
        9661        9543        9431        9240        9083       10387        9497        8677
  Columns 17 through 20
        9204        9415        9449        9379
compare_mat =
   3.2481e-02   1.6209e-01
   3.1897e-02   1.5554e-01
   3.0437e-02   1.5154e-01
   2.6700e-02   1.4838e-01
   2.5076e-02   1.4057e-01
   2.4550e-02   1.3859e-01
   2.4409e-02   1.3483e-01
   2.3569e-02   1.2513e-01
   2.0560e-02   1.1546e-01
   2.0131e-02   1.0703e-01
   1.8878e-02   1.0383e-01
   1.7924e-02   9.3764e-02
   1.6977e-02   8.7402e-02
   1.4016e-02   8.1929e-02
   1.2199e-02   6.5858e-02
   1.0292e-02   5.6656e-02
   7.9561e-03   4.7595e-02
   7.4175e-03   3.5422e-02
   4.0990e-03   2.0579e-02
   1.9636e-03   9.5650e-03
   
   i =
     5
last_k_columns_matrix_i =
  Columns 1 through 8
       14577       13150       13041       13106       12805       12301       12430       12461
  Columns 9 through 16
       12985       12943       13254       13016       13255       12980       13602       12474
  Columns 17 through 20
       12941       12964       12954       12761
compare_mat =
   3.7672e-02   1.7703e-01
   3.6423e-02   1.6607e-01
   3.2946e-02   1.5961e-01
   2.9165e-02   1.5638e-01
   2.8752e-02   1.4823e-01
   2.7685e-02   1.4571e-01
   2.6889e-02   1.4364e-01
   2.4596e-02   1.3518e-01
   2.2352e-02   1.3068e-01
   2.1692e-02   1.1549e-01
   2.1161e-02   1.1274e-01
   2.1031e-02   1.0020e-01
   1.7807e-02   9.2240e-02
   1.5621e-02   8.7707e-02
   1.4552e-02   6.8218e-02
   1.1175e-02   6.3183e-02
   9.1143e-03   5.0541e-02
   8.2406e-03   4.0884e-02
   4.9307e-03   2.2657e-02
   2.2715e-03   1.0671e-02

   
   i =
     6
last_k_columns_matrix_i =
  Columns 1 through 8
       17274       16386       15995       16121       16265       16964       16765       16733
  Columns 9 through 16
       16023       16319       17069       16308       17055       16393       15744       16675
  Columns 17 through 20
       16310       16354       16085       16034
compare_mat =
   6.5047e-03   3.6753e-02
   6.4507e-03   3.5212e-02
   6.0728e-03   3.0064e-02
   6.0264e-03   2.6681e-02
   5.8376e-03   2.6382e-02
   5.5511e-03   2.4076e-02
   5.2476e-03   2.2337e-02
   4.2541e-03   2.0476e-02
   3.5590e-03   1.8890e-02
   3.4373e-03   1.8215e-02
   3.3853e-03   1.4520e-02
   2.6696e-03   1.2776e-02
   2.5762e-03   1.0885e-02
   1.9002e-03   9.1823e-03
   1.6357e-03   6.9660e-03
   1.4228e-03   5.4176e-03
   8.5604e-04   4.1551e-03
   5.2735e-04   1.9090e-03
   3.1315e-04   1.2825e-03
   8.6000e-05   2.5681e-04

i =
     7
last_k_columns_matrix_i =
  Columns 1 through 8
       19964       19261       24066       19942       20310       17684       19238       19655
  Columns 9 through 16
       17997       17920       19272       19033       19562       20235       20363       19435
  Columns 17 through 20
       19418       17909       19426       17886
compare_mat =
   7.0152e-03   3.7038e-02
   6.5223e-03   3.5251e-02
   6.3323e-03   3.0442e-02
   6.0781e-03   2.9830e-02
   6.0258e-03   2.9603e-02
   5.6547e-03   2.4364e-02
   5.2949e-03   2.1981e-02
   4.4684e-03   2.0430e-02
   3.9522e-03   1.8566e-02
   3.4402e-03   1.7679e-02
   3.4070e-03   1.5167e-02
   2.7077e-03   1.3094e-02
   2.5970e-03   1.0890e-02
   2.1579e-03   9.8784e-03
   1.6361e-03   6.8932e-03
   1.4254e-03   5.4171e-03
   9.5645e-04   4.5136e-03
   5.2851e-04   1.8697e-03
   3.3008e-04   1.2432e-03
   8.6897e-05   2.5659e-04
   
   
   i =
     8
last_k_columns_matrix_i =
  Columns 1 through 8
       22121       22672       24145       22314       22486       21167       22593       22664
  Columns 9 through 16
       21359       21495       22549       21627       23037       22089       23131       22754
  Columns 17 through 20
       22774       21447       22882       23276
compare_mat =
   3.2481e-02   1.6209e-01
   3.1897e-02   1.5554e-01
   3.0437e-02   1.5154e-01
   2.6700e-02   1.4838e-01
   2.5076e-02   1.4057e-01
   2.4550e-02   1.3859e-01
   2.4409e-02   1.3483e-01
   2.3569e-02   1.2513e-01
   2.0560e-02   1.1546e-01
   2.0131e-02   1.0703e-01
   1.8878e-02   1.0383e-01
   1.7924e-02   9.3764e-02
   1.6977e-02   8.7402e-02
   1.4016e-02   8.1929e-02
   1.2199e-02   6.5858e-02
   1.0292e-02   5.6656e-02
   7.9561e-03   4.7595e-02
   7.4175e-03   3.5422e-02
   4.0990e-03   2.0579e-02
   1.9636e-03   9.5650e-03
   
 %----------------------------------------------------------------------------------------------------
 % check the smallest singular values of A and R22
       
 compare_mat =
   2.0342e-04      4.3529e-02
   1.6835e-04      3.0885e-02
   1.3005e-04      8.3947e-03
   9.6260e-05      4.2040e-03
   9.2788e-05      2.7897e-03
   6.3105e-05      2.7076e-03
   5.8562e-05      2.6248e-03
   5.8247e-05      1.9082e-03
   4.9657e-05      1.6075e-03
   2.5040e-05      1.5318e-03
   2.0160e-05      1.5048e-03
   7.5145e-06      8.1110e-04
   7.4408e-06      7.5499e-04
   1.3439e-06      2.1164e-04
   1.5715e-15      2.0194e-04
   1.1265e-15      6.5793e-05
   9.5551e-16      2.2590e-05
   6.2407e-16      8.6812e-15
   4.6607e-16      5.5268e-15
   3.6665e-16      4.8762e-15

 %----------------------------------------------------------------------------------------------------
% %last k columns from QRCP on A
% %QRCP on A
% [Q_A,R_A,P_A] = qr(full(A),'vector');   
% 
% %last k columns from QRCP on A
% last_k_columns_QRCP_A = P_A(end-k+1:end)
% R22_A=R_A(end-k+1:end,end-k+1:end); % size k x k
% 
% %svd of R22_A
% sR22_A=svd(full(R22_A));
% sR22_A_k = sR22_A(end-k+1:end);
       
        %sort
%        last_k_columns_QRCP_A =[24392       18260       24305         200        7124        3968       20228         107 24599       22112        3092       16196       24569       10013         378         910 22245       24320         884         629]
%    last_k_columns_QRCP_A = sort(last_k_columns_QRCP_A,2)
   last_k_columns_QRCP_A =
  Columns 1 through 8
         107         200         378         629         884         910        3092        3968
  Columns 9 through 16
        7124       10013       16196       18260       20228       22112       22245       24305
  Columns 17 through 20
       24320       24392       24569       24599
   
       
   last_k_columns_QRCP_TournamentPivoting=
   Columns 1 through 8
         636         918        1403        3311        3940        4096        5625        5812
  Columns 9 through 16
        5923        9214        9379        9415       12761       12954       12985       16023
  Columns 17 through 20
       16034       16085       20310       22486
   
   %--------------------------------------------------
%    compare_last_k_columns = [last_k_columns_QRCP_A; last_k_columns_matrix_i'];
%    compare_last_k_columns=sort(compare_last_k_columns,2)'

% 1st subdomain:           1 < i < 2640
% 2nd subdomain:        2640 < i < 5280
% 1st local interface:  5281 < i < 5544
% 3rd subdomain:        5545 < i < 8424
% 4th subdomain:        8425 < i < 11304
% 2nd local interface: 11305 < i < 11592

% 1st global interface: 11593 < i < 12096

% 5th subdomain:        12097 < i < 14736
% 6th subdomain:        14737 < i < 17376
% 3rd local interface:  17377 < i < 17640
% 7th subdomain:        17641 < i < 20520
% 8th subdomain:        20521 < i < 23400
% 4th local interface:  23401 < i < 23688

% 2nd global interface: 23689 < i < 24192

% 3rd global interface: 24193 < i < 24696



% compare_last_k_columns =
%      last_k_columns_QRCP_A                                last_k_columns_QRCP_TournamentPivoting
%                      107     1st subdomain                       636       1st subdomain 
%                      200     1st subdomain                       918       1st subdomain      
%                      378     1st subdomain                       1403      1st subdomain 
%                      629     1st subdomain                       3311      2nd subdomain
%                      884     1st subdomain                       3940      2nd subdomain
%                      910     1st subdomain                       4096      2nd subdomain
%                     3092     2nd subdomain                       5625      3rd subdomain
%                     3968     2nd subdomain                       5812      3rd subdomain
%                     7124     3rd subdomain                       5923      3rd subdomain
%                    10013     4th subdomain                       9214      4th subdomain
%                    16196     6th subdomain                       9379      4th subdomain
%                    18260     7th subdomain                       9415      4th subdomain
%                    20228     7th subdomain                       12761     5th subdomain
%                    22112     8th subdomain                       12954     5th subdomain
%                    22245     8th subdomain                       12985     5th subdomain
%                    24305     3rd global interface                16023     6th subdomain
%                    24320     3rd global interface                16034     6th subdomain
%                    24392     3rd global interface                16085     6th subdomain
%                    24569     3rd global interface                20310     7th subdomain
%                    24599     3rd global interface                22486     8th subdomain

%selected columns from QRCP of A
selected_columns_QRCP_A = A0(:,last_k_columns_QRCP_A);
%selected columns from QRCP with tournament pivoting
selected_columns_QRCP_TournamentPivoting = A0(:,selected_columns_QRCP_TournamentPivoting);

figure
spy(selected_columns_QRCP_A)
figure
spy(selected_columns_QRCP_TournamentPivoting)


   compare_mat = [ sA_k sR22_A_k sR22_final_k]
compare_mat =
   2.0342e-04   3.1028e-03   4.3529e-02
   1.6835e-04   2.5172e-03   3.0885e-02
   1.3005e-04   1.8938e-03   8.3947e-03
   9.6260e-05   1.7378e-03   4.2040e-03
   9.2788e-05   1.5074e-03   2.7897e-03
   6.3105e-05   1.2838e-03   2.7076e-03
   5.8562e-05   7.6478e-04   2.6248e-03
   5.8247e-05   6.5002e-04   1.9082e-03
   4.9657e-05   5.9837e-04   1.6075e-03
   2.5040e-05   5.2313e-04   1.5318e-03
   2.0160e-05   2.5438e-04   1.5048e-03
   7.5145e-06   1.3508e-04   8.1110e-04
   7.4408e-06   8.2636e-05   7.5499e-04
   1.3439e-06   2.6334e-05   2.1164e-04
   1.5715e-15   8.5687e-14   2.0194e-04
   1.1265e-15   6.6783e-14   6.5793e-05
   9.5551e-16   3.2931e-14   2.2590e-05
   6.2407e-16   7.9649e-15   8.6812e-15
   4.6607e-16   5.9511e-15   5.5268e-15
   3.6665e-16   5.2255e-15   4.8762e-15
   
%add the last global interface
BB = [BB A0(:,subdomain_indices_fullfill{end})];

last_k_columns_QRCP_TournamentPivoting =
       24625
       24568
       24617
       24580
       24595
       24666
       24468
       24690
       24692
       24522
       24462
       24210
       24335
       24317
       24488
       24308
       24448
       24231
       24559
       24641
       
sR22_final_k =
   2.9665e-01
   2.8747e-01
   2.8188e-01
   2.7346e-01
   2.7086e-01
   2.6709e-01
   2.6052e-01
   2.5202e-01
   2.3758e-01
   2.2616e-01
   2.2548e-01
   1.8262e-01
   1.7373e-01
   1.2519e-01
   1.0882e-01
   5.2089e-02
   3.0499e-02
   1.5483e-03
   9.8778e-15
   8.9107e-15
   
   %   BB = [BB A0(:,subdomain_indices_fullfill{end})]; %add the global
    %   interface

%   %add all interfaces
% for i=3:2+log2(npes)
% %     i=i+1
%     for j=1:number_subdomains
%         %     j=j+1
%         if size(subdomain_indices{j,i},1)~= 0
%             BB =  [BB A0(:,subdomain_indices{j,i})];
%         end
%     end
% end
  
last_k_columns_QRCP_TournamentPivoting =
       11498
       17420
       24145
       24066
       11534
       17395
       11459
       17447
       11588
       17558
       11513
       17412
       11553
       17385
       11567
       17577
       12053
       24145
       11969
       24066
   
  sR22_final_k =
   1.4739e-01
   1.4739e-01
   1.1285e-01
   1.1272e-01
   5.1176e-02
   5.0709e-02
   3.0182e-02
   2.9813e-02
   9.8486e-03
   9.2361e-03
   1.6104e-03
   9.7767e-04
   5.4305e-04
   2.0202e-04
   4.4788e-05
   1.6295e-14
   9.0264e-15
   7.5249e-15
   4.2917e-17
   2.4989e-18 
   

   %   %add global interfaces without removing duplicated columns
% for i=4:2+log2(npes)
% %     i=i+1
%     for j=1:number_subdomains
%         %     j=j+1
%         if size(subdomain_indices{j,i},1)~= 0
%             BB =  [BB A0(:,subdomain_indices{j,i})];
%         end
%     end
% end
   
last_k_columns_QRCP_TournamentPivoting_without =[
       11888
       11639
       11929
       11598
       23985
       23735
       12024
       11996
       23694
       24026
       24092
       24119
       11969
       12053
       24145
       24066
       11969
       24066
       12053
       24145]
       
       sR22_final_k_without =[
   2.1286e-01
   2.1220e-01
   2.0572e-01
   2.0515e-01
   1.1723e-01
   1.0748e-01
   8.8168e-02
   7.7466e-02
   2.5566e-02
   2.2087e-02
   5.1180e-03
   3.9936e-03
   2.4060e-04
   6.5583e-05
   2.1945e-14
   1.4605e-14
   2.1562e-16
   1.0299e-16
   6.0087e-17
   6.2889e-18]
   
   compare_mat =
   2.0342e-04   2.0342e-04   2.1286e-01   4.0769e-04   1.7835e-02   5.7716e-03
   1.6835e-04   1.6838e-04   2.1220e-01   4.0164e-04   1.4045e-02   5.0235e-03
   1.3005e-04   1.3007e-04   2.0572e-01   3.8470e-04   1.3514e-02   4.7219e-03
   9.6260e-05   9.6263e-05   2.0515e-01   3.4513e-04   1.2398e-02   4.3778e-03
   9.2788e-05   9.2788e-05   1.1723e-01   2.0941e-04   1.1053e-02   3.7534e-03
   6.3105e-05   6.3106e-05   1.0748e-01   2.0739e-04   1.0911e-02   2.3770e-03
   5.8562e-05   5.8562e-05   8.8168e-02   1.9275e-04   1.0092e-02   1.6411e-03
   5.8247e-05   5.8247e-05   7.7466e-02   1.8086e-04   9.0250e-03   1.5728e-03
   4.9657e-05   4.9673e-05   2.5566e-02   1.5657e-04   7.4935e-03   1.0167e-03
   2.5040e-05   2.5042e-05   2.2087e-02   1.3893e-04   5.6693e-03   9.7232e-04
   2.0160e-05   2.0162e-05   5.1180e-03   9.9399e-05   4.6449e-03   4.0453e-04
   7.5145e-06   7.5156e-06   3.9936e-03   7.5579e-05   3.5724e-03   2.4670e-04
   7.4408e-06   7.4413e-06   2.4060e-04   7.2319e-05   3.2718e-03   8.3766e-05
   1.3439e-06   1.3439e-06   6.5583e-05   6.5009e-05   2.5941e-03   1.6176e-05
   1.6995e-15   1.3924e-15   2.1945e-14   5.9546e-05   2.1591e-03   1.1466e-14
   1.0470e-15   9.7038e-16   1.4605e-14   5.0536e-05   1.6304e-03   9.5235e-15
   7.4806e-16   9.0442e-16   2.1562e-16   2.1720e-05   1.3649e-03   7.8470e-15
   5.5264e-16   4.6197e-16   1.0299e-16   1.7894e-05   1.0073e-03   7.8094e-15
   3.4317e-16   3.7923e-16   6.0087e-17   9.8680e-06   4.2906e-05   4.0792e-15
   2.7525e-16   3.2698e-16   6.2889e-18   8.7633e-06   8.0459e-06   3.2694e-15
   
   
   
   % with removing duplicated columns
   %add global interfaces
   
   last_k_columns_QRCP_TournamentPivoting_with =[
       24641
       23718
       23992
       23727
       11888
       11639
       11929
       11598
       23985
       23735
       12024
       11996
       23694
       24026
       24092
       24119
       11969
       12053
       24145
       24066]
       
       
       
       sR22_final_k_with =[
   1.7405e-01
   1.7276e-01
   1.6832e-01
   1.6713e-01
   1.2655e-01
   1.2077e-01
   1.1454e-01
   9.4125e-02
   8.4724e-02
   6.8966e-02
   3.0750e-02
   2.4138e-02
   1.6823e-02
   4.4616e-03
   2.2929e-03
   2.2291e-04
   2.1336e-04
   1.1221e-14
   8.4215e-15
   7.3135e-15]
   
   
   %add all interfaces
   sR22_final_k =[
   1.6417e-01
   1.6391e-01
   1.4391e-01
   1.4382e-01
   1.1261e-01
   1.1240e-01
   4.9671e-02
   4.9284e-02
   2.9448e-02
   2.9137e-02
   8.6545e-03
   8.1726e-03
   1.3554e-03
   8.6550e-04
   4.4356e-04
   1.7177e-04
   4.0179e-05
   1.6017e-14
   6.8157e-15
   4.4834e-15]

last_k_columns_QRCP_TournamentPivoting =[
       11479
       17433
       11969
       12053
       11498
       17420
       24145
       24066
       11534
       17395
       11459
       17447
       11588
       17558
       11513
       17412
       11553
       17385
       11567
       17577]
